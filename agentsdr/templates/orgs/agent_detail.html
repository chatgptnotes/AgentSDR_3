{% extends "layout.html" %}

{% block title %}{{ agent.name }} - {{ organization.name }}{% endblock %}

{% block content %}
<div class="space-y-8" x-data="{
    fetchingEmails: false,
    testing: false,
    fetchCriteria: 'last_24_hours',
    customCount: 10,
    error: null
}">
    <!-- Enhanced Header -->
    <div class="card-gradient rounded-xl shadow-lg overflow-hidden">
        <div class="px-8 py-8 relative">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                        <span class="text-3xl">
                            {% if agent.agent_type == 'email_summarizer' %}üìß
                            {% elif agent.agent_type == 'hubspot_data' %}üîó
                            {% else %}ü§ñ{% endif %}
                        </span>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white">{{ agent.name }}</h1>
                        <p class="text-white/80 text-lg">{{ agent.agent_type.replace('_', ' ').title() }}</p>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <a href="{{ url_for('orgs.list_agents', org_slug=organization.slug) }}" 
                       class="btn-gradient py-3 px-6 rounded-xl font-semibold transition-all duration-300 hover:scale-105">
                        ‚Üê Back to Agents
                    </a>
                </div>
            </div>
            <div class="absolute top-4 right-4 text-white/10 text-6xl float-up">‚ö°</div>
        </div>
    </div>

    {% if agent.agent_type == 'email_summarizer' %}
    <!-- Email Summarizer Interface -->
    <div class="bg-white rounded-xl shadow-lg p-8">
        <div class="flex items-center space-x-3 mb-6">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                <span class="text-white text-lg">üìß</span>
            </div>
            <h3 class="text-2xl font-bold text-gray-900">Email Summarizer</h3>
        </div>

        {% if not gmail_connected %}
        <!-- Gmail Connection Required -->
        <div class="text-center py-12">
            <div class="w-20 h-20 bg-gradient-to-br from-red-500 to-pink-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="text-3xl text-white">üìß</span>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-4">Gmail Connection Required</h3>
            <p class="text-gray-600 mb-8 max-w-md mx-auto">
                To start summarizing emails, you need to connect your Gmail account. This will allow the agent to access and summarize your emails.
            </p>
            <button onclick="connectGmail('{{ organization.slug }}', '{{ agent.id }}')" 
                    class="btn-gradient inline-flex items-center py-4 px-8 rounded-xl font-semibold text-lg transition-all duration-300 hover:scale-105 pulse-glow">
                üîó Connect Gmail Account
            </button>
        </div>
        {% else %}
        <!-- Gmail Connected - Email Fetching Options -->
        <div class="space-y-6">
            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg border border-green-200">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                        <span class="text-white text-sm">‚úì</span>
                    </div>
                    <div>
                        <h4 class="font-semibold text-green-800">Gmail Connected</h4>
                        <p class="text-green-600 text-sm">Your Gmail account is connected and ready to use.</p>
                    </div>
                </div>
                <button onclick="testConnection()" 
                        :disabled="$store.emailData.testing"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-sm">
                    <span x-show="!$store.emailData.testing">Test Connection</span>
                    <span x-show="$store.emailData.testing">Testing...</span>
                </button>
            </div>

            <!-- Email Fetching Options -->
            <div>
                <h4 class="text-lg font-semibold text-gray-900 mb-4">Choose Email Criteria</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 reveal-list">
                    <button type="button" 
                            :class="$store.emailData.fetchCriteria === 'last_24_hours' ? 'border-blue-500 bg-blue-50' : 'border-gray-300'"
                            @click="$store.emailData.fetchCriteria = 'last_24_hours'"
                            class="border-2 rounded-lg p-4 text-left hover:border-blue-400 transition-colors">
                        <div class="font-medium text-gray-900">Last 24 Hours</div>
                        <div class="text-sm text-gray-600">Get emails from the past day</div>
                    </button>
                    
                    <button type="button" 
                            :class="$store.emailData.fetchCriteria === 'last_7_days' ? 'border-blue-500 bg-blue-50' : 'border-gray-300'"
                            @click="$store.emailData.fetchCriteria = 'last_7_days'"
                            class="border-2 rounded-lg p-4 text-left hover:border-blue-400 transition-colors">
                        <div class="font-medium text-gray-900">Last 7 Days</div>
                        <div class="text-sm text-gray-600">Get emails from the past week</div>
                    </button>
                    
                    <button type="button" 
                            :class="$store.emailData.fetchCriteria === 'latest_n' ? 'border-blue-500 bg-blue-50' : 'border-gray-300'"
                            @click="$store.emailData.fetchCriteria = 'latest_n'"
                            class="border-2 rounded-lg p-4 text-left hover:border-blue-400 transition-colors">
                        <div class="font-medium text-gray-900">Latest N Emails</div>
                        <div class="text-sm text-gray-600">Get the most recent emails</div>
                        <div x-show="$store.emailData.fetchCriteria === 'latest_n'" class="mt-2">
                            <input type="number" x-model.number="$store.emailData.customCount" min="1" max="100" 
                                   class="w-20 px-2 py-1 border border-gray-300 rounded text-sm">
                            <span class="text-sm text-gray-600 ml-1">emails</span>
                        </div>
                    </button>
                    
                    <button type="button" 
                            :class="$store.emailData.fetchCriteria === 'oldest_n' ? 'border-blue-500 bg-blue-50' : 'border-gray-300'"
                            @click="$store.emailData.fetchCriteria = 'oldest_n'"
                            class="border-2 rounded-lg p-4 text-left hover:border-blue-400 transition-colors">
                        <div class="font-medium text-gray-900">Oldest N Emails</div>
                        <div class="text-sm text-gray-600">Get the oldest unread emails</div>
                        <div x-show="$store.emailData.fetchCriteria === 'oldest_n'" class="mt-2">
                            <input type="number" x-model.number="$store.emailData.customCount" min="1" max="100" 
                                   class="w-20 px-2 py-1 border border-gray-300 rounded text-sm">
                            <span class="text-sm text-gray-600 ml-1">emails</span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Fetch Button -->
            <div class="text-center">
                <button onclick="fetchAndSummarizeEmails()" 
                        :disabled="$store.emailData.fetchingEmails"
                        class="btn-gradient inline-flex items-center py-4 px-8 rounded-xl font-semibold text-lg transition-all duration-300 hover:scale-105"
                        :class="{ 'opacity-50 cursor-not-allowed': $store.emailData.fetchingEmails }">
                    <span x-show="!$store.emailData.fetchingEmails">üìß Fetch & Summarize Emails</span>
                    <span x-show="$store.emailData.fetchingEmails" class="flex items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Processing...
                    </span>
                </button>
            </div>

            <!-- Error Display -->
            <div x-show="$store.emailData.error" class="p-4 bg-red-50 border border-red-200 rounded-lg">
                <div class="flex items-center">
                    <span class="text-red-500 mr-2">‚ùå</span>
                    <span class="text-red-700" x-text="$store.emailData.error"></span>
                </div>
            </div>

            <!-- Summaries Container -->
            <div id="summaries-container" class="mt-8">
                <!-- Summaries will be displayed here -->
            </div>

            <!-- Automated Scheduling Section -->
            <div class="bg-white rounded-xl shadow-lg p-8 mt-8">
                <div class="flex items-center space-x-3 mb-6">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                        <span class="text-white text-lg">‚è∞</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900">Automated Daily Summaries</h3>
                </div>

                <div class="space-y-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-start space-x-3">
                            <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-white text-xs">‚ÑπÔ∏è</span>
                            </div>
                            <div>
                                <h4 class="font-semibold text-blue-900 mb-1">How it works</h4>
                                <p class="text-blue-700 text-sm">
                                    Set up automated daily email summaries that will be sent to your email at your chosen time. 
                                    The system will automatically fetch emails from the last 24 hours and send you a summary.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Form -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Daily Time</label>
                                <input type="time" id="scheduleTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Recipient Email</label>
                                <input type="email" id="recipientEmail" placeholder="your-email@example.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <button onclick="saveSchedule()" class="btn-gradient py-3 px-6 rounded-lg font-semibold transition-all duration-300 hover:scale-105">
                                üíæ Save Schedule
                            </button>
                            <button onclick="toggleSchedule()" id="toggleScheduleBtn" class="px-4 py-3 bg-gray-600 text-white rounded-lg font-semibold transition-all duration-300 hover:scale-105">
                                ‚è∏Ô∏è Pause Schedule
                            </button>
                        </div>
                    </div>

                    <!-- Current Schedule Display -->
                    <div id="currentSchedule" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-900 mb-2">Current Schedule</h4>
                        <div class="text-sm text-gray-600">
                            <p><strong>Time:</strong> <span id="currentTime">-</span></p>
                            <p><strong>Email:</strong> <span id="currentEmail">-</span></p>
                            <p><strong>Status:</strong> <span id="currentStatus">-</span></p>
                            <p><strong>Last Run:</strong> <span id="lastRun">-</span></p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        {% endif %}
    </div>
    {% else %}
    <!-- Other Agent Types -->
    <div class="bg-white rounded-xl shadow-lg p-8 text-center">
        <div class="w-20 h-20 bg-gradient-to-br from-gray-400 to-gray-600 rounded-full flex items-center justify-center mx-auto mb-6">
            <span class="text-4xl text-white">ü§ñ</span>
        </div>
        <h3 class="text-2xl font-bold text-gray-900 mb-4">{{ agent.agent_type.replace('_', ' ').title() }}</h3>
        <p class="text-gray-600 text-lg mb-8">
            This agent type is not yet implemented. Coming soon!
        </p>
    </div>
    {% endif %}
</div>

<script>
async function connectGmail(orgSlug, agentId) {
    try {
        // Redirect to Gmail OAuth
        window.location.href = `/orgs/${orgSlug}/agents/${agentId}/gmail/auth`;
    } catch (error) {
        console.error('Error connecting Gmail:', error);
        alert('Failed to connect Gmail. Please try again.');
    }
}

function fetchAndSummarizeEmails() {
    const alpine = Alpine.store('emailData');
    alpine.fetchingEmails = true;
    alpine.error = null;

    const criteria = {
        type: alpine.fetchCriteria,
        count: alpine.customCount
    };

    console.log('Sending criteria:', criteria);
    console.log('customCount value:', alpine.customCount, 'type:', typeof alpine.customCount);

    fetch(`/orgs/{{ organization.slug }}/agents/{{ agent.id }}/emails/summarize`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(criteria)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            alpine.error = data.error;
        } else if (data.success) {
            // Display summaries directly on this page
            showToast(`Found ${data.count} emails!`, 'success');
            displaySummaries(data.summaries, data.criteria_type);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alpine.error = `Failed to fetch and summarize emails: ${error.message}`;
    })
    .finally(() => {
        alpine.fetchingEmails = false;
    });
}

function displaySummaries(summaries, criteriaType) {
    // Create summaries display HTML
    const summariesHtml = summaries.map((summary, index) => `
        <div class="p-6 hover:bg-gray-50 transition-colors border-b border-gray-200">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center space-x-3 mb-2">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                            <span class="text-white font-semibold text-sm">${summary.sender ? summary.sender[0].toUpperCase() : '?'}</span>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900">${summary.sender || 'Unknown'}</h3>
                            <p class="text-sm text-gray-500">${summary.date || 'Unknown date'}</p>
                        </div>
                    </div>
                    
                    <h4 class="font-medium text-gray-900 mb-2">${summary.subject || 'No Subject'}</h4>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-3">
                        <p class="text-gray-700 leading-relaxed">${summary.summary || 'No summary available'}</p>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    // Update the summaries container
    const summariesContainer = document.getElementById('summaries-container');
    if (summariesContainer) {
        summariesContainer.innerHTML = `
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="px-8 py-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Email Summaries</h2>
                            <p class="text-gray-600 mt-1">${summaries.length} email${summaries.length !== 1 ? 's' : ''} summarized</p>
                        </div>
                        <div class="text-sm text-gray-500">
                            Criteria: ${criteriaType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                        </div>
                    </div>
                </div>
                
                <div class="divide-y divide-gray-200">
                    ${summariesHtml}
                </div>
            </div>
        `;
        
        // Scroll to summaries
        summariesContainer.scrollIntoView({ behavior: 'smooth' });
    }
}

function testConnection() {
    const alpine = Alpine.store('emailData');
    alpine.testing = true;
    alpine.error = null;
    
    fetch(`/orgs/{{ organization.slug }}/agents/{{ agent.id }}/emails/test`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(`‚úì Gmail connection working! Email: ${data.email}, Total messages: ${data.total_messages}`, 'success');
        } else {
            alpine.error = data.error || 'Connection test failed';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alpine.error = `Connection test failed: ${error.message}`;
    })
    .finally(() => {
        alpine.testing = false;
    });
}

// Initialize Alpine.js store
document.addEventListener('alpine:init', () => {
    Alpine.store('emailData', {
        fetchingEmails: false,
        testing: false,
        fetchCriteria: 'last_24_hours',
        customCount: 10,
        error: null
    });
});

// Scheduling functions
function saveSchedule() {
    const scheduleTime = document.getElementById('scheduleTime').value;
    const recipientEmail = document.getElementById('recipientEmail').value;
    
    if (!scheduleTime || !recipientEmail) {
        showToast('Please fill in both time and email fields', 'error');
        return;
    }
    
    fetch(`/orgs/{{ organization.slug }}/agents/{{ agent.id }}/schedule`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            schedule_time: scheduleTime,
            recipient_email: recipientEmail,
            criteria_type: 'last_24_hours'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Schedule saved successfully!', 'success');
            loadCurrentSchedule();
        } else {
            showToast(data.error || 'Failed to save schedule', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving schedule:', error);
        showToast('Failed to save schedule', 'error');
    });
}

function toggleSchedule() {
    fetch(`/orgs/{{ organization.slug }}/agents/{{ agent.id }}/schedule/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.is_active ? 'Schedule activated!' : 'Schedule paused!', 'success');
            loadCurrentSchedule();
        } else {
            showToast(data.error || 'Failed to toggle schedule', 'error');
        }
    })
    .catch(error => {
        console.error('Error toggling schedule:', error);
        showToast('Failed to toggle schedule', 'error');
    });
}

function loadCurrentSchedule() {
    fetch(`/orgs/{{ organization.slug }}/agents/{{ agent.id }}/schedule`)
    .then(response => response.json())
    .then(data => {
        if (data.schedule) {
            document.getElementById('currentSchedule').classList.remove('hidden');
            document.getElementById('currentTime').textContent = data.schedule.schedule_time;
            document.getElementById('currentEmail').textContent = data.schedule.recipient_email;
            document.getElementById('currentStatus').textContent = data.schedule.is_active ? 'Active' : 'Paused';
            document.getElementById('lastRun').textContent = data.schedule.last_run_at ? new Date(data.schedule.last_run_at).toLocaleString() : 'Never';
            
            // Update form fields
            document.getElementById('scheduleTime').value = data.schedule.schedule_time;
            document.getElementById('recipientEmail').value = data.schedule.recipient_email;
            
            // Update toggle button
            const toggleBtn = document.getElementById('toggleScheduleBtn');
            if (data.schedule.is_active) {
                toggleBtn.textContent = '‚è∏Ô∏è Pause Schedule';
                toggleBtn.className = 'px-4 py-3 bg-red-600 text-white rounded-lg font-semibold transition-all duration-300 hover:scale-105';
            } else {
                toggleBtn.textContent = '‚ñ∂Ô∏è Activate Schedule';
                toggleBtn.className = 'px-4 py-3 bg-green-600 text-white rounded-lg font-semibold transition-all duration-300 hover:scale-105';
            }
        } else {
            document.getElementById('currentSchedule').classList.add('hidden');
        }
    })
    .catch(error => {
        console.error('Error loading schedule:', error);
    });
}

// Load current schedule on page load
document.addEventListener('DOMContentLoaded', loadCurrentSchedule);
</script>
{% endblock %}
